{% extends "shopapp/../base.html" %}
{% load static %}
{% block links %}
    <link rel="stylesheet" href="{% static "css/book.css" %}">
{% endblock %}
{% block main %}
    <main>
        <h1>Single book</h1>
        <section id="single-book">
            <figure>
                <img class="book-cover" src="/static/img/{{ book.img }}" alt="book title">
                <figcaption>{{ book.author }}</figcaption>
            </figure>
            <p>{{ book.description }}</p>
            <h4>Available in stock: {{ book.stock }}</h4>
            <h3>Price: ${{ book.price }}</h3>
            <h1>book id: {{ book.id }}</h1>
            <h4>Language:
                <a href="{% url 'browse' %}?language={{ book.language|lower }}"><b>{{ book.language }}</b></a>
            </h4>
        
            <h4>Original Language: {{ book.original_language }}</h4>
            <h3>Categories:</h3>
            {% for category in categories %}
                <a href="{% url 'browse' %}?category={{ category }}" class="category-tag">
                    <b>{{ category|lower|capfirst }}</b>
                </a>
            {% endfor %}
            {% if book.read == True %}
                <form action="../books/seneka/seneka-read">
                    <input type="submit" value="Read online">
                </form>
            {% endif %}
            {% if book.stock > 0 %}
                <button class="add-to-cart" data-book-id="{{ book.id }}">Add to Cart</button>
            {% else %}
                <div class="tooltip">
                    <button class="not-available" data-book-id="{{ book.id }}" disabled>
                        Add to Cart
                    </button>
                    <span class="tooltiptext">Book out of stock</span>
                </div>
                
            {% endif %}

        </section>

        <section id="score-section">
            {% if user.is_authenticated %}
                <h3>Rate this Book:</h3>
                <form id="score-form" action="{% url 'submit-score' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="book_id" value="{{ book.id }}">
                    <input type="number" name="score" min="1" max="5" required>
                    <input type="submit" value="Submit Score">
                </form>
            {% else %}
                <p><b>You must be logged in to rate this book.</b></p>
            {% endif %}
            <div id="average-score">
                <h3>Average Score: <span id="average-score-value">{{ average_score }}</span></h3>
            </div>
        </section>

        <section id="reviews">
            <h2>Reviews</h2>
            <div id="review-list">
                {% for review in reviews %}
                    <div class="review">
                        <p>{{ review.text }}</p>
                        <small>Reviewed by {{ review.user.username }} on {{ review.created_at|date:"Y-m-d H:i" }}</small>
                    </div>
                {% empty %}
                    <p>No reviews yet.</p>
                {% endfor %}
            </div>

            {% if user.is_authenticated %}
                <form id="review-form" method="post" data-action-url="{% url 'post_review' book.id %}">
                    {% csrf_token %}
                    <textarea name="text" required></textarea>
                    <input type="submit" value="Submit Review">
                </form>

            {% else %}
                <p><b>You must be logged in to post a review.</b></p>
            {% endif %}
        </section>


    </main>
    
            <script>
                document.querySelectorAll('.add-to-cart').forEach(button => {
                    button.addEventListener('click', function() {
                        const bookId = this.getAttribute('data-book-id');
                         if (!bookId) {
                            console.error('Book ID is not defined');
                            return;
                        }
                        fetch("{% url 'add-to-cart' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: 'book_id=' + bookId + '&quantity=1'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Book added to cart!');

                                // Update the total quantity displayed
                                const quantityDisplay = document.querySelector('.quantity');
                                if (quantityDisplay) {
                                    quantityDisplay.textContent = data.total_quantity;
                                }
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })

                        .catch(error => console.error('Error:', error));

                    });
                });
            </script>
{% endblock %}

{% block javascript %}
    <script src="{% static "/js/review.js" %}"></script>
    <script src="{% static "/js/score.js" %}"></script>
{% endblock %}